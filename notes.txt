////////////////////////////////////////////////////////////////
 __  __                     _          __  __
|  \/  |                   | |        |  \/  |
| \  / | __ _ _ __  _   _  | |_ ___   | \  / | __ _ _ __  _   _
| |\/| |/ _` | '_ \| | | | | __/ _ \  | |\/| |/ _` | '_ \| | | |
| |  | | (_| | | | | |_| | | || (_) | | |  | | (_| | | | | |_| |
|_|  |_|\__,_|_| |_|\__, |  \__\___/  |_|  |_|\__,_|_| |_|\__, |
                    __/ |                                 __/ |
                   |___/                                 |___/
                                  Many to Many Notes by >>> bern
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

                    /////////// Key \\\\\\\\\
                          â• Edit File
                          ğŸ® console command
                    /////////////\\\\\\\\\\\\\

has_and_belongs_to_many -> you don't need a model for the join table
Rails allows us to not do any join queries
âŒ â˜ï¸ inadvisable, because you cannot access the joined table

One to many association
|Question|-<|Like|>-|User|

 âœ… ğŸ‘‡ Proper way
 has_many :through

ğŸ® >>> rails g model like user:references question:references
      spring stop -> to fix error in cache
      spring is a gem that caches in memory state of rails app
ğŸ® >>> rails db:migrate

check in console if things work

â• Open User model -> user.rb
  has_many :likes, dependent: :destroy
  ğŸ‘† destroy likes if user is deleted

â• Open Question model -> question.rb
  has_many :likes, dependent: :destroy

ğŸ® in rails console -> reload!

â• Open User model -> user.rb
      has_many :liked_questions, through: likes, source: :question
               through likes is the join table ğŸ‘†, source is the other table we are trying to reach

â• Open Question model -> question.rb
      has_many :likers, through: :likes, source: :user
ğŸ® -> rails console
      q = Question.first
      q.likers << User.last
      u = User.last
      all questions the user has liked -> u.liked_questions.create(title: "What do you like", body: "things and stuff")
      u.questions.create
      likes -> all likes
      likes << (object)
      likes = (objects)
      likes_singular_ids
      likes.size -> count
      likes.where
      likes.exists?
      likes.find
â• Open like model ->like.rb
    # validation guarantees a user can only like a question once
      validates :question_id, uniqueness: {scope: :user_id}
ğŸ® -> reload!
      u = User.last
      u.likes.create(question: Question.first)
       -> didn't rollback ğŸ¤”
       ğŸ‘‡ try again
       l = Like.new(user: User.first, question: Question.first)
       l.save
       â˜‘ï¸ ROLLBACK! ->it worked!
       l.errors -> question_id has already been taken

â• Show.html.erb
       <%= link_to "Like", question_likes_path(@question), method: :post %>

â• routes
       resources :likes, only: [:create, :destroy]

ğŸ® create likes controller -> rails g controller likes create destroy --skip-template-engine --skip-assets

â• delete created likes routes in routes.rb

â• likes controller

â• show
      <%# pluralize is a helper method that takes a number as first argument a d a word
      as a second argument. It will pluralize the word based on the queantity represented
      by the first argument. Finally, it will return them joined together
      (e.g pluralize(6, 'dog') # return '6 dogs')  %>
      (<%= pluralize @question.likes.count, 'like' %>)


      <!--  look for likes associated with user -->
      <% like = @question.likes.find_by(user: current_user)  %>


â• likes controller
  destroy method write it

â•  in show add
      <% if user_signed_in?  %>
        <% if like.present?  %>
          <%= link_to "Un-Like", like_path(like), method: :delete %>
        <% else  %>
          <%= link_to "Like", question_likes_path(@question), method: :post %>
        <% end  %>
      <% end  %>

â• likes controller
      before_action :authenticate_user!

â• block people from liking their own things -> ability.rb
      # cannot only defines the ability for the cannot?() method
      cannot :like, Question do |q|
        user == q.user
      end
      # can defines the ability for the can?() method
      can :like, Question do |q|
        user != q.user
      end

â• likes controller
        if cannot? :like, @question
          redirect_to question_path(@question), alert: 'Liking your own question isn\'t allowed'
          # redirect_to and render does not prevent the rest of the method from executing
          # calling redirect_to and/or render twice or more in an action will cause an error
          # ğŸ‘‡ do an early return in an action if the rest of the code should not be executed
          return
        end
â• show.html.erb
      edit line 7 to add cancan validation
        <% if user_signed_in? && can?(:like, @question) %>

â• edit destroy method in likes controller
      if cannot? :like, @like.question
        redirect_to question_path(@like.question), alert: 'Un-Liking your own question isn\'t allowed'
        return
      end

/////   Refactoring code   \\\\\
1. Query inside view âŒ
      add instance method to question model to check if that user liked that question

â• question model define new instance method

        def liked_by?(user)
          # exists? returns true if the query in the argument returns something
          # it reutrs true if there is a like with the user reference 'user'
          likes.exists?(user: user)
        end

        def like_for(user)
          # find any like that has a user reference of current user
          likes.find_by(user: user)
        end


â– in show delete
  <% like = @question.likes.find_by(user: current_user)  %>
  change forğŸ‘‡
  <% if @question.liked_by?(current_user)  %>
    <%= link_to "Un-Like", like_path(@question.like_for(current_user)), method: :delete %>
  <% else  %>


2. create likes views

â• routes
        resources :users, only: [:new, :create] do
          resources :likes, only: [:index]
        end
â• likes controller  define index method
        def index
            @user = User.find(params[:user_id])
            @questions = @user.liked_questions
        end

â• create a view app/views/likes/index.html.erb -> edit file
â• to edit like button in show
          <%= link_to '<i class="fa fa-thumbs-down" aria-hidden="true"></i>'.html_safe, like_path(@question.like_for(current_user)), method: :delete %>
